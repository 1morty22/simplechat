<!-- templates/workspace.html -->
{% extends "base.html" %}
{% block title %} Your Workspace - {{ app_settings.app_title }} {% endblock %}
{% block head %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplemde/dist/simplemde.min.css" />
  <style>
    /* Force fixed layout so columns don't expand when content changes */
    #documents-table {
      table-layout: fixed;
      width: 100%;
    }

    /* Example: Keep the expand-arrow column narrow */
    #documents-table th:nth-child(1),
    #documents-table td:nth-child(1) {
      width: 50px;
      text-align: Left;
    }

    /* File Name column */
    #documents-table th:nth-child(2),
    #documents-table td:nth-child(2) {
      min-width: 50px;
      max-width: 150px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis; /* if you want "..." on overflow */
    }

    /* Title column */
    #documents-table th:nth-child(3),
    #documents-table td:nth-child(3) {
      min-width: 50px;
      max-width: 200px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    /* Actions column */
    #documents-table th:nth-child(4),
    #documents-table td:nth-child(4) {
      width: 200px; /* or whatever fits your buttons */
    }

    /* Style for the classification badge */
    .classification-badge {
        display: inline-block;
        padding: 0.3em 0.6em;
        font-size: 0.85em;
        font-weight: 600;
        line-height: 1;
        color: #fff; /* Default white text */
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.375rem; /* Bootstrap's default badge radius */
        /* Text color adjustment based on background lightness might be needed */
    }
    /* Helper function (or manual calculation) needed to determine if text should be dark */
    .classification-badge.text-dark {
        color: #212529 !important; /* Bootstrap dark text color */
    }

  </style>
{% endblock %}

{% block content %}
  <div class="container">
    <h2>Your Workspace</h2>

    <!-- Nav Tabs -->
    <ul class="nav nav-tabs" id="workspaceTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button
          class="nav-link active"
          id="documents-tab-btn"
          data-bs-toggle="tab"
          data-bs-target="#documents-tab"
          type="button"
          role="tab"
          aria-controls="documents-tab"
          aria-selected="true"
        >
          Your Documents
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="prompts-tab-btn"
          data-bs-toggle="tab"
          data-bs-target="#prompts-tab"
          type="button"
          role="tab"
          aria-controls="prompts-tab"
          aria-selected="false"
        >
          Your Prompts
        </button>
      </li>
    </ul>

    <!-- Tab Panes -->
    <div class="tab-content" id="workspaceTabContent">
      <!-- ============= DOCUMENTS TAB ============= -->
      <div
        class="tab-pane fade show active"
        id="documents-tab"
        role="tabpanel"
        aria-labelledby="documents-tab-btn"
      >
        <div class="card p-3 my-3">
          <h5>Your Documents</h5>
          <p class="text-muted">Only you can see documents you upload. Allowed extensions
            'txt', 'pdf', 'docx', 'xlsx', 'xls', 'csv', 'pptx', 'html', 'jpg', 'jpeg',
            'png', 'bmp', 'tiff', 'tif', 'heif', 'md', 'json'
            {% if settings.enable_video_file_support %}
                , 'mp4', 'mov', 'avi', 'wmv', 'mkv', 'webm' {# Add relevant video extensions #}
            {% endif %}
            {% if settings.enable_audio_file_support %}
                , 'mp3', 'wav', 'ogg', 'aac', 'flac', 'm4a' {# Add relevant audio extensions #}
            {% endif %}
          </p>

          <!-- Document Upload Form -->
          <div class="mb-3">
            <input type="file" id="file-input" multiple /> {# Allow multiple files if desired #}
            <button id="upload-btn" class="btn btn-primary">
              Upload Document(s)
            </button>
            <span id="upload-status" class="ms-2 text-muted small"></span>
          </div>

          <!-- Documents List -->
          <table class="table table-striped" id="documents-table">
            <thead>
              <tr>
                <th></th>
                <th>File Name</th>
                <th>Title</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Populated by JavaScript -->
            </tbody>
          </table>

          <div class="d-flex align-items-center gap-3 mb-3">
            <!-- Page Size Section -->
            <div>
              <label for="page-size-select" class="visually-hidden">Items per page:</label>
              <select id="page-size-select" class="form-select form-select-sm d-inline-block" style="width:auto;">
                <option value="10" selected>10</option>
                <option value="20">20</option>
                <option value="50">50</option>
              </select>
              <span class="ms-1 small text-muted">items per page</span>
            </div>

            <!-- Pagination Controls -->
            <div id="pagination-container" class="d-flex gap-1 ms-auto"></div> {# Use ms-auto to push pagination right #}
          </div>

        </div>
      </div>
      <!-- End DOCUMENTS TAB -->

      <!-- ============= PROMPTS TAB ============= -->
      <div
        class="tab-pane fade"
        id="prompts-tab"
        role="tabpanel"
        aria-labelledby="prompts-tab-btn"
      >
        <div class="card p-3 my-3">
          <h5>Your Prompts</h5>
          <p class="text-muted">Create and manage personal prompts here.</p>
          <div class="mb-3">
            <button id="create-prompt-btn" class="btn btn-success">
              New Prompt
            </button>
          </div>

          <table class="table table-striped" id="prompts-table">
            <thead>
              <tr>
                <th>Prompt Name</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
      <!-- End PROMPTS TAB -->
    </div>
    <!-- End Tab Content -->
  </div>

  <!-- Modal for Creating/Editing Prompts -->
  <!-- (Keep Existing Prompt Modal As Is) -->
  <div
    class="modal fade"
    id="promptModal"
    tabindex="-1"
    aria-labelledby="promptModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-xl" style="max-width: 80%">
      <form id="prompt-form">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="promptModalLabel">Create Prompt</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="prompt-id" name="prompt_id" value="" />
            <div class="mb-3">
              <label for="prompt-name" class="form-label">Prompt Name</label>
              <input
                type="text"
                class="form-control"
                id="prompt-name"
                name="name"
                required
              />
            </div>
            <div class="mb-3">
              <label for="prompt-content" class="form-label"
                >Prompt Content</label
              >
              <textarea
                class="form-control"
                id="prompt-content"
                name="content"
                rows="10"
              ></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button id="prompt-save-btn" type="submit" class="btn btn-primary">
              Save Prompt
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal for Editing Document Metadata -->
  <div
    class="modal fade"
    id="docMetadataModal"
    tabindex="-1"
    aria-labelledby="docMetadataModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <form id="doc-metadata-form">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="docMetadataModalLabel">
              Edit Document Metadata
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>

          <div class="modal-body">
            <!-- Hidden doc-id field -->
            <input type="hidden" id="doc-id" name="doc_id" value="" />

            <!-- Document Classification -->
            {% if settings.enable_document_classification %}
            <div class="mb-3">
              <label for="doc-classification" class="form-label"
                >Document Classification</label
              >
              <select class="form-select" id="doc-classification">
                <option value="">-- Select Classification --</option>
                {# *** Corrected Loop *** #}
                {% for cat in settings.document_classification_categories %}
                  <option value="{{ cat.label }}">{{ cat.label }}</option>
                {% endfor %}
              </select>
            </div>
            {% endif %}

            <!-- Title -->
            <div class="mb-3">
              <label for="doc-title" class="form-label">Title</label>
              <input type="text" class="form-control" id="doc-title" />
            </div>

            <!-- Abstract -->
            <div class="mb-3">
              <label for="doc-abstract" class="form-label">Abstract</label>
              <textarea
                class="form-control"
                id="doc-abstract"
                rows="3"
              ></textarea>
            </div>

            <!-- Keywords -->
            <div class="mb-3">
              <label for="doc-keywords" class="form-label"
                >Keywords (comma separated)</label
              >
              <input type="text" class="form-control" id="doc-keywords" />
            </div>

            <!-- Publication Date -->
            <div class="mb-3">
              <label for="doc-publication-date" class="form-label"
                >Publication Date</label
              >
              <input
                type="text"
                class="form-control"
                id="doc-publication-date"
                placeholder="e.g. 08/2005"
              />
            </div>

            <!-- Authors -->
            <div class="mb-3">
              <label for="doc-authors" class="form-label"
                >Authors (comma separated)</label
              >
              <input type="text" class="form-control" id="doc-authors" />
            </div>
          </div>
          <!-- end modal-body -->

          <div class="modal-footer">
            <button id="doc-save-btn" type="submit" class="btn btn-primary">
              Save Metadata
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

{% endblock %}

{% block scripts %}
  <!-- Library Dependencies (Make sure SimpleMDE is loaded first) -->
  <script src="https://cdn.jsdelivr.net/npm/simplemde/dist/simplemde.min.js"></script>

  <!-- Global Settings Passed from Server -->
  <script>
    // Make sure these are properly JSON encoded and escaped if necessary in your backend
    // Using 'tojson' filter with 'safe' is usually correct for Jinja2
    window.classification_categories = JSON.parse('{{ settings.document_classification_categories|tojson(indent=None)|safe }}' || '[]');
    // Ensure it's always an array, just in case the setting is missing or null
    if (!Array.isArray(window.classification_categories)) {
        window.classification_categories = [];
    }
    // Pass boolean flags as strings 'True'/'False' or numbers 1/0, and check accordingly in JS
    // Or use tojson | safe for true/false -> true/false in JS
    window.enable_document_classification = "{{ settings.enable_document_classification|tojson|safe }}"; // e.g., true or false
    window.enable_extract_meta_data = "{{ settings.enable_extract_meta_data|tojson|safe }}"; // e.g., true or false

     // Convert boolean to string 'True'/'False' if needed for backward compatibility with previous JS checks
     // window.enable_document_classification = "{{ settings.enable_document_classification }}";
     // window.enable_extract_meta_data = "{{ settings.enable_extract_meta_data }}";

  </script>

  <!-- Your Custom Workspace Scripts -->
  <!-- Adjust paths if your static folder structure is different -->
  <!-- Using url_for is the recommended Flask/Jinja way -->
  <script type="module" src="{{ url_for('static', filename='js/workspace/workspace-utils.js') }}"></script>
  <script type="module" src="{{ url_for('static', filename='js/workspace/workspace-documents.js') }}"></script>
  <script type="module" src="{{ url_for('static', filename='js/workspace/workspace-prompts.js') }}"></script>
  <script type="module" src="{{ url_for('static', filename='js/workspace/workspace-init.js') }}"></script>

  <!-- Example using direct paths (less robust than url_for) -->
  <!--
  <script src="/static/js/workspace/workspace-documents.js"></script>
  <script src="/static/js/workspace/workspace-prompts.js"></script>
  <script src="/static/js/workspace/workspace-init.js"></script>
  -->

{% endblock %}