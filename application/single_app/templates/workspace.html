<!-- templates/workspace.html -->
{% extends "base.html" %} {% block title %} Your Workspace - {{
app_settings.app_title }} {% endblock %} {% block head %}
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/simplemde/dist/simplemde.min.css"
/>
{% endblock %} {% block content %}

<div class="container">
  <h2>Your Workspace</h2>

  <!-- Nav Tabs -->
  <ul class="nav nav-tabs" id="workspaceTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button
        class="nav-link active"
        id="documents-tab-btn"
        data-bs-toggle="tab"
        data-bs-target="#documents-tab"
        type="button"
        role="tab"
        aria-controls="documents-tab"
        aria-selected="true"
      >
        Your Documents
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        id="prompts-tab-btn"
        data-bs-toggle="tab"
        data-bs-target="#prompts-tab"
        type="button"
        role="tab"
        aria-controls="prompts-tab"
        aria-selected="false"
      >
        Your Prompts
      </button>
    </li>
  </ul>

  <!-- Tab Panes -->
  <div class="tab-content" id="workspaceTabContent">
    <!-- ============= DOCUMENTS TAB ============= -->
    <div
      class="tab-pane fade show active"
      id="documents-tab"
      role="tabpanel"
      aria-labelledby="documents-tab-btn"
    >
      <div class="card p-3 my-3">
        <h5>Your Documents</h5>
        <p class="text-muted">Note: Only you can see documents you upload.</p>

        <!-- Document Upload Form -->
        <div class="mb-3">
          <input type="file" id="file-input" />
          <button id="upload-btn" class="btn btn-primary">
            Upload Document
          </button>
        </div>

        <!-- Documents List -->
        <table class="table table-striped" id="documents-table">
          <thead>
            <tr>
              <th></th>
              <th>File Name</th>
              <th>Title</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
    <!-- End DOCUMENTS TAB -->

    <!-- ============= PROMPTS TAB ============= -->
    <div
      class="tab-pane fade"
      id="prompts-tab"
      role="tabpanel"
      aria-labelledby="prompts-tab-btn"
    >
      <div class="card p-3 my-3">
        <h5>Your Prompts</h5>
        <p class="text-muted">Create and manage personal prompts here.</p>
        <div class="mb-3">
          <button id="create-prompt-btn" class="btn btn-success">
            New Prompt
          </button>
        </div>

        <table class="table table-striped" id="prompts-table">
          <thead>
            <tr>
              <th>Prompt Name</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
    <!-- End PROMPTS TAB -->
  </div>
  <!-- End Tab Content -->
</div>

<!-- Modal for Creating/Editing Prompts -->
<div
  class="modal fade"
  id="promptModal"
  tabindex="-1"
  aria-labelledby="promptModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-xl" style="max-width: 80%">
    <form id="prompt-form">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="promptModalLabel">Create Prompt</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="prompt-id" name="prompt_id" value="" />
          <div class="mb-3">
            <label for="prompt-name" class="form-label">Prompt Name</label>
            <input
              type="text"
              class="form-control"
              id="prompt-name"
              name="name"
              required
            />
          </div>
          <div class="mb-3">
            <label for="prompt-content" class="form-label"
              >Prompt Content</label
            >
            <textarea
              class="form-control"
              id="prompt-content"
              name="content"
              rows="10"
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button id="prompt-save-btn" type="submit" class="btn btn-primary">
            Save Prompt
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal for Editing Document Metadata -->
<div
  class="modal fade"
  id="docMetadataModal"
  tabindex="-1"
  aria-labelledby="docMetadataModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <form id="doc-metadata-form">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="docMetadataModalLabel">
            Edit Document Metadata
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>

        <div class="modal-body">
          <!-- doc-id Hidden Field -->
          <input type="hidden" id="doc-id" name="doc_id" value="" />

          <!-- Title -->
          <div class="mb-3">
            <label for="doc-title" class="form-label">Title</label>
            <input type="text" class="form-control" id="doc-title" />
          </div>

          <!-- Removed doc-enhanced-citations field -->
          <!-- Removed doc-number-of-pages field -->

          <!-- Abstract -->
          <div class="mb-3">
            <label for="doc-abstract" class="form-label">Abstract</label>
            <textarea
              class="form-control"
              id="doc-abstract"
              rows="3"
            ></textarea>
          </div>

          <!-- Keywords -->
          <div class="mb-3">
            <label for="doc-keywords" class="form-label"
              >Keywords (comma separated)</label
            >
            <input type="text" class="form-control" id="doc-keywords" />
          </div>

          <!-- Publication Date -->
          <div class="mb-3">
            <label for="doc-publication-date" class="form-label"
              >Publication Date</label
            >
            <input
              type="text"
              class="form-control"
              id="doc-publication-date"
              placeholder="e.g. 08/2005"
            />
          </div>

          <!-- Authors -->
          <div class="mb-3">
            <label for="doc-authors" class="form-label"
              >Authors (comma separated)</label
            >
            <input type="text" class="form-control" id="doc-authors" />
          </div>
        </div>
        <!-- end .modal-body -->

        <div class="modal-footer">
          <button id="doc-save-btn" type="submit" class="btn btn-primary">
            Save Metadata
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

{% endblock %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/simplemde/dist/simplemde.min.js"></script>

<script>
  // ------------------ Documents Section ------------------
  const fileInput = document.getElementById("file-input");
  const uploadBtn = document.getElementById("upload-btn");
  const documentsTableBody = document.querySelector("#documents-table tbody");
  const docMetadataModalEl = new bootstrap.Modal(
    document.getElementById("docMetadataModal")
  );
  const docMetadataForm = document.getElementById("doc-metadata-form");

  function onEditDocument(docId) {
    // Fetch the doc from server to get fresh data
    fetch(`/api/documents/${docId}`)
      .then((r) => r.json())
      .then((doc) => {
        if (doc.error) {
          alert("Error retrieving document: " + doc.error);
          return;
        }

        // Populate the form fields
        document.getElementById("doc-id").value = doc.id;
        document.getElementById("doc-title").value = doc.title || "";
        document.getElementById("doc-abstract").value = doc.abstract || "";
        if (Array.isArray(doc.keywords)) {
          document.getElementById("doc-keywords").value = doc.keywords.join(", ");
        } else if (typeof doc.keywords === "string") {
          // if it's already a string, just show it
          document.getElementById("doc-keywords").value = doc.keywords;
        } else {
          // fallback
          document.getElementById("doc-keywords").value = "";
        }
        document.getElementById("doc-publication-date").value =
          doc.publication_date || "";
          if (Array.isArray(doc.authors)) {
            // If doc.authors is an array, join them for the input box
            document.getElementById("doc-authors").value = doc.authors.join(", ");
          } else if (typeof doc.authors === "string") {
            // If it's already a string, just show it
            document.getElementById("doc-authors").value = doc.authors;
          } else {
            // If it's null or something else, fallback to empty
            document.getElementById("doc-authors").value = "";
          }

        docMetadataModalEl.show();
      })
      .catch((err) => {
        console.error("Error:", err);
      });
  }

  // Handle form submit => call PATCH
  docMetadataForm.addEventListener("submit", (e) => {
    e.preventDefault();

    const docId = document.getElementById("doc-id").value;
    const payload = {
      title: document.getElementById("doc-title").value,
      abstract: document.getElementById("doc-abstract").value,
      keywords: document.getElementById("doc-keywords").value,
      publication_date: document.getElementById("doc-publication-date").value,
      authors: document.getElementById("doc-authors").value,
    };

    // Convert comma separated strings to arrays if needed
    if (typeof payload.keywords === "string") {
      payload.keywords = payload.keywords.split(",").map((kw) => kw.trim());
    }
    if (typeof payload.authors === "string") {
      payload.authors = payload.authors.split(",").map((a) => a.trim());
    }

    fetch(`/api/documents/${docId}`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(payload),
    })
      .then((r) => r.json())
      .then((updatedDoc) => {
        if (updatedDoc.error) {
          alert("Error updating document: " + updatedDoc.error);
          return;
        }
        alert("Document metadata updated successfully!");
        docMetadataModalEl.hide();

        // Re-fetch all documents to update the table row
        fetchUserDocuments();
      })
      .catch((err) => {
        console.error("Error in update:", err);
      });
  });

  // Fetch & render all user documents
  function fetchUserDocuments() {
    fetch("/api/documents")
      .then((response) => response.json())
      .then((data) => {
        documentsTableBody.innerHTML = "";
        (data.documents || []).forEach((doc) => {
          renderDocumentRow(doc);
        });
      })
      .catch((error) => {
        console.error("Error fetching documents:", error);
      });
  }

  // Renders a single document row (+ optional progress rows)
  function renderDocumentRow(doc) {
    let authors = "";
    if (Array.isArray(doc.authors)) {
      // doc.authors is something like ["BENSON", "Tally"]
      authors = doc.authors.join(", "); // => "BENSON, Tally"
    } else if (typeof doc.authors === "string") {
      authors = doc.authors;
    }

    const docId = doc.id;
    // Safely parse or default to 0
    const pct = parseInt(doc.percentage_complete, 10) || 0;
    const docStatus = doc.status || "";

    // Main doc row
    // A helper to show/hide the details row.
    const canExpand = pct === 100; // only if processing complete
    const arrowButton = canExpand
      ? `<button class="btn btn-link" onclick="toggleDetails('${docId}')">
            <span id="arrow-icon-${docId}" class="bi bi-chevron-right"></span>
        </button>`
      : ""; // or a disabled icon

    const docRow = document.createElement("tr");
    docRow.id = `doc-row-${docId}`;
    docRow.innerHTML = `
      <td>${arrowButton}</td>
      <td>${doc.file_name || ""}</td>
      <td>${doc.title || ""}</td>
      <td>
        <button
          class="btn btn-sm btn-danger"
          onclick="deleteDocument('${docId}')"
        >
          Delete
        </button>
        <button
          class="btn btn-sm btn-primary"
          onclick="redirectToChat('${docId}')"
        >
          Search in Chat
        </button>
      </td>
    `;
    documentsTableBody.appendChild(docRow);

    // Create a collapsible details row right after it (hidden by default).
    if (canExpand) {
      const detailsRow = document.createElement("tr");
      const enhancedBadge = doc.enhanced_citations
        ? `<span class="badge bg-success">Enhanced</span>`
        : `<span class="badge bg-secondary">Standard</span>`;
      detailsRow.id = `details-row-${docId}`;
      detailsRow.style.display = "none"; // hidden by default
      detailsRow.innerHTML = `
      <td colspan="4">
        <div class="bg-light p-3 border rounded">
          <p><strong>Version:</strong> ${doc.version || ""}</p>
          <p><strong>Authors:</strong> ${authors}</p>
          <p><strong>Number of Pages:</strong> ${doc.number_of_pages || ""}</p>
          <p><strong>Enhanced Citations:</strong> ${enhancedBadge}</p>
          <p><strong>Abstract:</strong> ${doc.abstract || ""}</p>
          <p><strong>Keywords:</strong>
            ${
              Array.isArray(doc.keywords)
                ? doc.keywords.join(", ")
                : (typeof doc.keywords === "string" ? doc.keywords : "")
            }
          </p>
          <p><strong>Publication Date:</strong> ${
            doc.publication_date || ""
          }</p>
          <button
            class="btn btn-sm btn-info"
            onclick="onEditDocument('${docId}')"
          >
            Edit Metadata
          </button>
        </div>
      </td>
    `;
      documentsTableBody.appendChild(detailsRow);
    }

    // Only show progress + status if <100% AND not "Processing complete"
    if (pct < 100 && !docStatus.toLowerCase().includes("processing complete")) {
      // Progress row
      const progressRow = document.createElement("tr");
      progressRow.id = `progress-row-${docId}`;
      progressRow.innerHTML = `
        <td colspan="4">
          <div class="progress" style="height: 20px;">
            <div
              id="progress-bar-${docId}"
              class="progress-bar progress-bar-striped bg-info"
              role="progressbar"
              style="width: ${pct}%;"
              aria-valuenow="${pct}"
              aria-valuemin="0"
              aria-valuemax="100"
            >
              ${pct}%
            </div>
          </div>
        </td>
      `;
      documentsTableBody.appendChild(progressRow);

      // Status row
      const statusRow = document.createElement("tr");
      statusRow.id = `status-row-${docId}`;
      statusRow.innerHTML = `
        <td colspan="4">
          <small class="text-muted">Status: ${docStatus}</small>
        </td>
      `;
      documentsTableBody.appendChild(statusRow);
    }
  }

  // Upload document
  uploadBtn.addEventListener("click", () => {
    const file = fileInput.files[0];
    if (!file) {
      alert("Please select a file to upload.");
      return;
    }

    const formData = new FormData();
    formData.append("file", file);

    fetch("/api/documents/upload", {
      method: "POST",
      body: formData,
    })
      .then((r) => r.json())
      .then((data) => {
        if (data.document_id) {
          const docId = data.document_id;
          // Refresh docs so the new doc row is added
          fetchUserDocuments();
          // Then poll for progress
          pollDocumentStatus(docId);
        } else if (data.error) {
          alert("Error uploading: " + data.error);
        }
      })
      .catch((err) => {
        console.error("Upload failed:", err);
      });
  });

  function fetchUserDocumentsAndPoll() {
    fetch("/api/documents")
      .then((response) => response.json())
      .then((data) => {
        documentsTableBody.innerHTML = "";
        (data.documents || []).forEach((doc) => {
          renderDocumentRow(doc);

          // If the doc is incomplete, start polling for status
          let pct = parseInt(doc.percentage_complete, 10) || 0;
          if (pct < 100 && !doc.status?.toLowerCase().includes("complete")) {
            pollDocumentStatus(doc.id);
          }
        });
      })
      .catch((error) => {
        console.error("Error fetching documents:", error);
      });
  }

  function toggleDetails(docId) {
    const detailsRow = document.getElementById(`details-row-${docId}`);
    if (!detailsRow) return;

    if (detailsRow.style.display === "none") {
      detailsRow.style.display = "";
      // Switch arrow icon from right to down
      const arrow = document.getElementById(`arrow-icon-${docId}`);
      if (arrow) arrow.className = "bi bi-chevron-down";
    } else {
      detailsRow.style.display = "none";
      // Switch arrow icon from down to right
      const arrow = document.getElementById(`arrow-icon-${docId}`);
      if (arrow) arrow.className = "bi bi-chevron-right";
    }
  }

  // Poll a doc's status until complete
  function pollDocumentStatus(documentId) {
    const pollInterval = setInterval(() => {
      fetch(`/api/documents/${documentId}`)
        .then((r) => r.json())
        .then((doc) => {
          if (doc.error) {
            clearInterval(pollInterval);
            alert("Error retrieving doc status: " + doc.error);
            return;
          }

          console.log("Doc status:", doc.status, doc.percentage_complete);

          // Safely parse
          const pct = parseInt(doc.percentage_complete, 10) || 0;
          const progressBar = document.getElementById(
            `progress-bar-${documentId}`
          );
          const statusRow = document.getElementById(`status-row-${documentId}`);

          // Update progress bar if it exists
          if (progressBar) {
            progressBar.style.width = pct + "%";
            progressBar.setAttribute("aria-valuenow", pct);
            progressBar.textContent = pct + "%";
          }

          // Update status text if row exists
          if (statusRow) {
            const smallEl = statusRow.querySelector("small");
            if (smallEl) {
              smallEl.textContent = "Status: " + (doc.status || "");
            }
          }

          // Once doc is done, remove progress & status rows
          if (doc.status?.toLowerCase().includes("complete") || pct >= 100) {
            clearInterval(pollInterval);
            alert("Upload complete!");

            const progressRow = document.getElementById(
              `progress-row-${documentId}`
            );
            if (progressRow) progressRow.remove();
            if (statusRow) statusRow.remove();
          }
        })
        .catch((err) => {
          console.error("Error in pollDocumentStatus:", err);
          clearInterval(pollInterval);
        });
    }, 3000);
  }

  // Delete a document
  function deleteDocument(documentId) {
    if (!confirm("Are you sure you want to delete this document?")) return;

    fetch(`/api/documents/${documentId}`, {
      method: "DELETE",
    })
      .then((response) => {
        if (!response.ok) {
          return response.json().then((data) => {
            alert(
              "Error deleting document: " + (data.error || "Unknown error")
            );
            throw new Error(data.error || "Delete failed");
          });
        }
        return response.json();
      })
      .then((data) => {
        alert(data.message);
        fetchUserDocuments();
      })
      .catch((error) => {
        console.error("Error deleting document:", error);
      });
  }

  // Redirect to chat with the doc ID
  function redirectToChat(documentId) {
    window.location.href = `/chats?search_documents=true&doc_scope=personal&document_id=${documentId}`;
  }

  // ------------------ Prompts Section ------------------
  const promptsTableBody = document.querySelector("#prompts-table tbody");
  const promptModalEl = new bootstrap.Modal(
    document.getElementById("promptModal")
  );
  const promptForm = document.getElementById("prompt-form");
  const promptIdEl = document.getElementById("prompt-id");
  const promptNameEl = document.getElementById("prompt-name");
  const promptContentEl = document.getElementById("prompt-content");

  // Initialize SimpleMDE for prompts
  let simplemde = new SimpleMDE({
    element: promptContentEl,
    spellChecker: false,
  });

  // Fetch user prompts
  function fetchUserPrompts() {
    fetch("/api/prompts")
      .then((r) => r.json())
      .then((data) => {
        if (data.error) {
          console.error("Error fetching prompts:", data.error);
          return;
        }
        promptsTableBody.innerHTML = "";
        (data.prompts || []).forEach((p) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p.name}</td>
            <td>
              <button
                class="btn btn-sm btn-primary"
                onclick="onEditPrompt('${p.id}')"
              >
                Edit
              </button>
              <button
                class="btn btn-sm btn-danger"
                onclick="onDeletePrompt('${p.id}')"
              >
                Delete
              </button>
            </td>
          `;
          promptsTableBody.appendChild(tr);
        });
      })
      .catch((err) => console.error("Error:", err));
  }

  // Show "Create Prompt" modal
  document.getElementById("create-prompt-btn").addEventListener("click", () => {
    promptModalEl.show();
    document.getElementById("promptModalLabel").textContent = "Create Prompt";
    promptIdEl.value = "";
    promptNameEl.value = "";
    promptContentEl.value = "";
    simplemde.value("");
  });

  // Create or update a prompt
  promptForm.addEventListener("submit", (e) => {
    e.preventDefault();
    promptContentEl.value = simplemde.value();

    const promptId = promptIdEl.value;
    const payload = {
      name: promptNameEl.value,
      content: promptContentEl.value,
    };

    if (!promptId) {
      // Create
      fetch("/api/prompts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      })
        .then((r) => r.json())
        .then((data) => {
          if (data.error) {
            alert("Error creating prompt: " + data.error);
            return;
          }
          promptModalEl.hide();
          fetchUserPrompts();
        })
        .catch((err) => console.error(err));
    } else {
      // Update
      fetch("/api/prompts/" + promptId, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      })
        .then((r) => r.json())
        .then((data) => {
          if (data.error) {
            alert("Error updating prompt: " + data.error);
            return;
          }
          promptModalEl.hide();
          fetchUserPrompts();
        })
        .catch((err) => console.error(err));
    }
  });

  // Edit an existing prompt
  window.onEditPrompt = function (promptId) {
    fetch("/api/prompts/" + promptId)
      .then((r) => r.json())
      .then((data) => {
        if (data.error) {
          alert("Error retrieving prompt: " + data.error);
          return;
        }
        document.getElementById("promptModalLabel").textContent = "Edit Prompt";
        promptIdEl.value = data.id;
        promptNameEl.value = data.name;
        promptContentEl.value = data.content;
        simplemde.value(data.content || "");
        promptModalEl.show();
      })
      .catch((err) => console.error(err));
  };

  // Delete a prompt
  window.onDeletePrompt = function (promptId) {
    if (!confirm("Are you sure you want to delete this prompt?")) return;
    fetch("/api/prompts/" + promptId, {
      method: "DELETE",
    })
      .then((r) => r.json())
      .then((data) => {
        if (data.error) {
          alert("Error deleting prompt: " + data.error);
          return;
        }
        fetchUserPrompts();
      })
      .catch((err) => console.error(err));
  };

  // Initial load
  fetchUserDocumentsAndPoll();
  fetchUserPrompts();

  // Optionally re-fetch if the user revisits the tab
  document.addEventListener("visibilitychange", () => {
    if (!document.hidden) {
      fetchUserDocumentsAndPoll();
    }
  });
</script>
{% endblock %}
